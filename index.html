<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gateway Zero</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: #1e293b; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
        .leaflet-container { background: #0f172a; }
        @keyframes flow { 0% { left: 0; opacity: 0; } 20% { opacity: 1; } 80% { opacity: 1; } 100% { left: 100%; opacity: 0; } }
        .animate-flow { animation: flow 2s linear infinite; }
        .toggle-checkbox:checked { right: 0; border-color: #3b82f6; }
        .toggle-checkbox:checked + .toggle-label { background-color: #3b82f6; }
        
        /* Map Dots Animation */
        .pulse-icon {
            border-radius: 50%;
            height: 12px;
            width: 12px;
            position: absolute;
            border: 2px solid white;
            box-shadow: 0 0 10px currentColor;
        }
        .pulse-icon:after {
            content: ''; width: 100%; height: 100%; position: absolute; border-radius: 50%;
            background-color: currentColor; opacity: 0.8;
            animation: pulse-ring 2s cubic-bezier(0.215, 0.61, 0.355, 1) infinite;
        }
        @keyframes pulse-ring { 0% { transform: scale(0.5); opacity: 0; } 50% { opacity: 0.5; } 100% { transform: scale(3); opacity: 0; } }
        .marker-green { color: #4ade80; background: #4ade80; }
        .marker-red { color: #ef4444; background: #ef4444; }
    </style>
</head>
<body class="bg-slate-900 text-slate-200 min-h-screen selection:bg-blue-500/30">
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- LOADING SPINNER -->
    <div id="view-loading" class="fixed inset-0 bg-slate-900 flex flex-col items-center justify-center z-50">
        <i data-lucide="shield" class="w-12 h-12 text-blue-500 animate-pulse mb-4"></i>
        <p class="text-slate-400">Gateway Zero lädt...</p>
    </div>

    <!-- SETUP VIEW -->
    <div id="view-setup" class="hidden min-h-screen flex items-center justify-center p-4">
        <div class="bg-slate-800 border border-slate-700 p-8 rounded-2xl w-full max-w-lg shadow-2xl">
            <div class="flex items-center gap-3 mb-6 justify-center">
                <div class="bg-blue-500/20 p-3 rounded-xl"><i data-lucide="rocket" class="w-8 h-8 text-blue-400"></i></div>
            </div>
            <h1 class="text-2xl font-bold text-center text-white mb-2">Willkommen bei Gateway Zero</h1>
            <p class="text-center text-slate-400 mb-8">Lass uns dein Sicherheits-Gateway in 30 Sekunden einrichten.</p>
            
            <form onsubmit="doSetup(event)" class="space-y-4">
                <div>
                    <label class="block text-sm text-slate-300 mb-1">Deine Domain (ohne http)</label>
                    <input id="setup-domain" class="w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-3 text-white placeholder-slate-600 focus:border-blue-500 outline-none" placeholder="z.B. mein-server.de" required>
                </div>
                <div>
                    <label class="block text-sm text-slate-300 mb-1">Admin Email (für SSL)</label>
                    <input id="setup-email" type="email" class="w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-3 text-white placeholder-slate-600 focus:border-blue-500 outline-none" placeholder="admin@beispiel.de" required>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm text-slate-300 mb-1">Admin Benutzer</label>
                        <input id="setup-user" class="w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-3 text-white focus:border-blue-500 outline-none" value="admin" required>
                    </div>
                    <div>
                        <label class="block text-sm text-slate-300 mb-1">Passwort</label>
                        <input id="setup-pass" type="password" class="w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-3 text-white focus:border-blue-500 outline-none" required>
                    </div>
                </div>
                <button type="submit" id="setup-btn" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-lg mt-4 transition shadow-lg shadow-blue-500/20 flex items-center justify-center">
                    System Starten
                </button>
            </form>
        </div>
    </div>

    <!-- LOGIN VIEW -->
    <div id="view-login" class="hidden min-h-screen flex items-center justify-center p-4">
        <div class="bg-slate-800 border border-slate-700 p-8 rounded-2xl w-full max-w-md shadow-2xl">
            <div class="text-center mb-8">
                <i data-lucide="lock" class="w-10 h-10 text-blue-400 mx-auto mb-4"></i>
                <h1 class="text-2xl font-bold text-white">Admin Login</h1>
                <p class="text-slate-400">Gateway Zero Dashboard</p>
            </div>
            <form onsubmit="doLogin(event)" class="space-y-4">
                <div>
                    <input id="login-user" class="w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-3 text-white outline-none focus:border-blue-500" placeholder="Benutzername" required>
                </div>
                <div>
                    <input id="login-pass" type="password" class="w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-3 text-white outline-none focus:border-blue-500" placeholder="Passwort" required>
                </div>
                <div id="login-error" class="text-red-400 text-sm text-center hidden">Falsche Zugangsdaten</div>
                <button type="submit" class="w-full bg-green-600 hover:bg-green-500 text-white font-bold py-3 rounded-lg transition shadow-lg shadow-green-500/20">Anmelden</button>
            </form>
        </div>
    </div>

    <!-- DASHBOARD VIEW -->
    <div id="view-dashboard" class="hidden pb-20">
        <!-- Navigation -->
        <nav class="border-b border-slate-700/60 bg-slate-900/50 backdrop-blur-md sticky top-0 z-30">
            <div class="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <i data-lucide="shield" class="w-6 h-6 text-blue-400"></i>
                    <span class="text-xl font-bold text-white">Gateway Zero</span>
                </div>
                <div class="flex items-center space-x-4">
                    <div id="status-indicator" class="hidden md:flex items-center text-sm text-green-400"><div class="w-2 h-2 bg-green-500 rounded-full mr-2 animate-pulse"></div>Online</div>
                    <div class="text-sm text-slate-400 font-mono" id="dash-domain"></div>
                    
                    <!-- Settings Trigger -->
                    <div class="flex items-center space-x-3 text-sm bg-slate-800 px-3 py-1.5 rounded-full border border-slate-700 cursor-pointer hover:bg-slate-700 transition" onclick="openSettings()">
                        <span class="text-slate-400">User:</span>
                        <span class="text-white font-medium">Daniel</span>
                        <i data-lucide="settings" class="w-3 h-3 ml-1 text-slate-400"></i>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Settings Modal (NEU) -->
        <div id="settings-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/90 backdrop-blur-sm hidden">
            <div class="bg-slate-800 border border-slate-700 rounded-2xl w-full max-w-2xl shadow-2xl p-6 relative">
                <button onclick="closeSettings()" class="absolute top-4 right-4 text-slate-400 hover:text-white"><i data-lucide="x" class="w-5 h-5"></i></button>
                <h2 class="text-xl font-bold text-white mb-6">System Einstellungen</h2>
                
                <div class="flex border-b border-slate-700 mb-6">
                    <button onclick="switchSetTab('oauth')" id="set-btn-oauth" class="pb-2 px-4 border-b-2 border-blue-500 text-blue-400 font-medium">OAuth / Google</button>
                    <button onclick="switchSetTab('firewall')" id="set-btn-firewall" class="pb-2 px-4 border-b-2 border-transparent text-slate-400 font-medium">Firewall & Listen</button>
                </div>

                <!-- OAuth Tab -->
                <div id="set-tab-oauth" class="space-y-4">
                    <p class="text-sm text-slate-400">Erstelle OAuth Credentials in der Google Cloud Console für die Redirect-URI: <br><code class="bg-slate-900 px-2 py-1 rounded text-blue-300 block mt-2">https://auth.<span class="domain-ph"></span>/callback</code></p>
                    <div>
                        <label class="block text-sm text-slate-300 mb-1">Google Client ID</label>
                        <input id="conf-client-id" class="w-full bg-slate-900 border border-slate-600 rounded px-3 py-2 text-white">
                    </div>
                    <div>
                        <label class="block text-sm text-slate-300 mb-1">Google Client Secret</label>
                        <input id="conf-client-secret" type="password" class="w-full bg-slate-900 border border-slate-600 rounded px-3 py-2 text-white">
                    </div>
                </div>

                <!-- Firewall Tab -->
                <div id="set-tab-firewall" class="hidden space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm text-green-400 mb-1">Global Whitelist (CIDR)</label>
                            <textarea id="conf-whitelist" class="w-full h-32 bg-slate-900 border border-slate-600 rounded p-2 text-white text-xs font-mono" placeholder="192.168.178.50/32&#10;10.0.0.0/8"></textarea>
                            <p class="text-xs text-slate-500 mt-1">Diese IPs umgehen Fail2Ban & GeoIP.</p>
                        </div>
                        <div>
                            <label class="block text-sm text-red-400 mb-1">Global Blacklist (CIDR)</label>
                            <textarea id="conf-blacklist" class="w-full h-32 bg-slate-900 border border-slate-600 rounded p-2 text-white text-xs font-mono" placeholder="1.2.3.4"></textarea>
                            <p class="text-xs text-slate-500 mt-1">Diese IPs werden sofort blockiert.</p>
                        </div>
                    </div>
                </div>

                <button onclick="saveSettings()" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 rounded mt-6">Speichern & Neustart</button>
            </div>
        </div>

        <main class="max-w-7xl mx-auto px-4 py-8 space-y-8">
            <div class="flex justify-between items-center">
                <h1 class="text-3xl font-bold text-white">Dashboard</h1>
                <button onclick="openWizard()" class="bg-blue-600 hover:bg-blue-500 text-white px-5 py-2 rounded-xl font-medium flex items-center transition">
                    <i data-lucide="plus" class="w-5 h-5 mr-2"></i> Dienst verbinden
                </button>
            </div>

            <!-- Flow -->
            <div class="relative flex items-center justify-between gap-4 py-8 overflow-x-auto">
                 <div class="flex flex-col items-center min-w-[100px]"><i data-lucide="globe" class="w-10 h-10 text-blue-400 mb-2"></i><span class="text-sm font-bold">Internet</span></div>
                 <div class="flex-1 h-0.5 bg-slate-700 relative overflow-hidden mx-4"><div class="absolute inset-0 bg-blue-500/50 animate-flow"></div></div>
                 <div class="flex-col items-center min-w-[100px] flex"><i data-lucide="shield-check" class="w-10 h-10 text-white mb-2"></i><span class="text-sm font-bold">Gateway</span></div>
                 <div class="flex-1 flex flex-col gap-2" id="flow-connections"></div>
            </div>

            <!-- Map & Log -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 h-[400px]">
                <div class="lg:col-span-2 bg-slate-800 rounded-2xl overflow-hidden border border-slate-700 relative">
                    <div id="map" class="w-full h-full z-0"></div>
                    <div class="absolute bottom-4 left-4 bg-slate-900/90 px-3 py-1 rounded-lg text-xs z-[1000] border border-slate-600">
                        <span class="text-green-400">●</span> Allow <span class="text-red-400 ml-2">●</span> Block
                    </div>
                </div>
                <div class="bg-slate-800 rounded-2xl border border-slate-700 p-4 flex flex-col">
                    <h3 class="font-bold text-white mb-4 flex items-center gap-2"><i data-lucide="activity" class="w-4 h-4"></i> Live Log</h3>
                    <div id="live-log-list" class="flex-1 overflow-y-auto space-y-2 text-xs font-mono pr-2 custom-scroll"></div>
                </div>
            </div>

            <!-- Hosts -->
            <div>
                <h2 class="text-xl font-bold text-white mb-4">Aktive Dienste</h2>
                <div id="host-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
            </div>
            
            <!-- Metrics -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 border-t border-slate-800 pt-6">
                <div class="bg-slate-800 p-4 rounded-xl border border-slate-700">
                    <div class="text-slate-400 text-sm mb-1">Ping (1.1.1.1)</div>
                    <div class="text-2xl font-bold text-white" id="stat-ping">- ms</div>
                </div>
                <div class="bg-slate-800 p-4 rounded-xl border border-slate-700">
                    <div class="text-slate-400 text-sm mb-1">Fail2Ban</div>
                    <div class="text-2xl font-bold text-white" id="stat-banned">0</div>
                </div>
                <div class="bg-slate-800 p-4 rounded-xl border border-slate-700">
                    <div class="text-slate-400 text-sm mb-1">Zertifikate</div>
                    <div class="text-2xl font-bold text-white" id="stat-ssl">OK</div>
                </div>
                <div class="bg-slate-800 p-4 rounded-xl border border-slate-700">
                    <div class="text-slate-400 text-sm mb-1">Aktive Hosts</div>
                    <div class="text-2xl font-bold text-white" id="stat-hosts">0</div>
                </div>
            </div>
        </main>
        
        <!-- Undo Toast -->
        <div id="undo-toast" class="fixed bottom-6 left-1/2 transform -translate-x-1/2 bg-slate-800 text-white px-6 py-3 rounded-full shadow-2xl border border-slate-700 flex items-center gap-4 z-50 hidden">
            <span id="undo-message">Änderung gespeichert</span>
            <button onclick="closeUndo()" class="text-slate-500 hover:text-white"><i data-lucide="x" class="w-4 h-4"></i></button>
        </div>

        <!-- Guest Pass Modal -->
        <div id="guest-pass-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/80 backdrop-blur-sm hidden">
            <div class="bg-slate-800 border border-slate-700 rounded-2xl w-full max-w-md shadow-2xl p-6 transform scale-95 transition-transform">
                <h3 class="text-xl font-bold text-white mb-2">Gäste-Pass erstellen</h3>
                <p class="text-sm text-slate-400 mb-6">Erstelle einen temporären Link für <span id="gp-service-name" class="text-white font-medium">Service</span>, der für 24 Stunden gültig ist und den Login umgeht.</p>
                
                <div class="bg-slate-900 rounded-lg p-3 border border-slate-700 flex items-center justify-between mb-6">
                    <code class="text-xs text-blue-300 font-mono truncate mr-2" id="gp-link">...</code>
                    <button class="text-slate-400 hover:text-white"><i data-lucide="copy" class="w-4 h-4"></i></button>
                </div>
                
                <button onclick="closeGuestPass()" class="w-full bg-blue-600 hover:bg-blue-500 text-white py-2 rounded-lg font-medium">Fertig</button>
            </div>
        </div>

        <!-- Wizard Modal -->
        <div id="wizard-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/80 backdrop-blur-sm hidden">
            <div class="bg-slate-800 border border-slate-700 rounded-2xl w-full max-w-2xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
                <div class="p-6 border-b border-slate-700 flex justify-between">
                    <h2 class="text-xl font-bold text-white">Neuen Dienst verbinden</h2>
                    <button onclick="closeWizard()" class="text-slate-400 hover:text-white"><i data-lucide="x" class="w-5 h-5"></i></button>
                </div>
                
                <div id="wizard-step-1" class="p-6 overflow-y-auto">
                    <div id="scan-loading" class="text-center py-10">
                        <i data-lucide="loader-2" class="w-10 h-10 text-blue-500 animate-spin mx-auto mb-4"></i>
                        <p class="text-white">Scanne Netzwerk ports...</p>
                    </div>
                    <div id="scan-results" class="hidden space-y-3">
                        <h3 class="text-white font-medium mb-2">Gefunden:</h3>
                        <div id="scan-list" class="grid gap-2"></div>
                        <div class="grid grid-cols-2 gap-3 mt-4">
                            <button onclick="manualSetup()" class="flex items-center justify-center p-4 border border-dashed border-slate-600 text-slate-400 hover:text-white hover:border-slate-400 rounded-xl transition">
                                <i data-lucide="plus" class="w-4 h-4 mr-2"></i> Manuell
                            </button>
                            <button onclick="startStaticHosting()" class="flex items-center justify-center p-4 border border-dashed border-slate-600 text-slate-400 hover:text-white hover:border-slate-400 rounded-xl transition">
                                <i data-lucide="upload-cloud" class="w-4 h-4 mr-2"></i> Statische Seite
                            </button>
                        </div>
                    </div>
                </div>

                <div id="wizard-step-2" class="hidden flex flex-col h-full">
                    <!-- Tabs -->
                    <div class="flex border-b border-slate-700 px-6 pt-4 bg-slate-900 sticky top-0 z-10">
                        <button onclick="switchTab('connection')" id="tab-btn-connection" class="pb-3 px-4 border-b-2 border-blue-500 text-blue-400 font-medium transition hover:text-blue-300">Verbindung</button>
                        <button onclick="switchTab('security')" id="tab-btn-security" class="pb-3 px-4 border-b-2 border-transparent text-slate-400 font-medium transition hover:text-white hover:border-slate-600">Schutzschild</button>
                        <button onclick="switchTab('advanced')" id="tab-btn-advanced" class="pb-3 px-4 border-b-2 border-transparent text-slate-400 font-medium transition hover:text-white hover:border-slate-600">Technik</button>
                    </div>

                    <div class="p-6 space-y-6 overflow-y-auto">
                        <!-- Connection Tab -->
                        <div id="tab-content-connection" class="space-y-4">
                            <div id="static-hosting-banner" class="hidden bg-purple-500/10 border border-purple-500/20 p-4 rounded-xl flex items-center justify-center border-dashed border-2 h-32 cursor-pointer hover:bg-purple-500/20 transition">
                                <div class="text-center" onclick="document.getElementById('file-upload').click()">
                                    <i data-lucide="upload" class="w-8 h-8 text-purple-400 mx-auto mb-2"></i>
                                    <h4 class="text-purple-200 font-medium">Datei auswählen</h4>
                                    <p class="text-xs text-purple-300/70">.html oder .zip</p>
                                    <input type="file" id="file-upload" class="hidden" onchange="uploadFile()">
                                </div>
                                <div id="upload-status" class="text-xs text-green-400 mt-2 hidden">Hochgeladen!</div>
                            </div>
                            
                            <div><label class="block text-sm text-slate-300 mb-1">Name</label><input id="input-name" class="w-full bg-slate-900 border border-slate-600 rounded px-3 py-2 text-white"></div>
                            <div class="grid grid-cols-2 gap-4" id="internal-config-row">
                                <div><label class="block text-sm text-slate-300 mb-1">Interne IP</label><input id="input-ip" class="w-full bg-slate-900 border border-slate-600 rounded px-3 py-2 text-white"></div>
                                <div><label class="block text-sm text-slate-300 mb-1">Port</label><input id="input-port" type="number" class="w-full bg-slate-900 border border-slate-600 rounded px-3 py-2 text-white"></div>
                            </div>
                            <div><label class="block text-sm text-slate-300 mb-1">Subdomain</label><div class="flex"><input id="input-sub" class="flex-1 bg-slate-900 border border-slate-600 rounded-l px-3 py-2 text-white"><div class="bg-slate-700 px-3 py-2 rounded-r border border-l-0 border-slate-600 text-slate-300" id="domain-suffix">.box</div></div></div>
                            <button id="fetch-icon-btn" onclick="fetchFavicon()" class="hidden w-full py-2 bg-slate-700 hover:bg-slate-600 text-slate-300 text-xs rounded-lg transition flex items-center justify-center gap-2"><i data-lucide="image-down" class="w-3 h-3"></i> Auto-Fetch Icon</button>
                        </div>

                        <!-- Security Tab -->
                        <div id="tab-content-security" class="hidden space-y-6">
                            <div class="bg-slate-700/30 p-4 rounded-xl border border-slate-700 flex items-center justify-between">
                                <div class="flex items-start space-x-3"><div class="bg-white rounded-full p-1.5 mt-0.5"><div class="text-slate-900 font-bold text-xs w-3 h-3 flex items-center justify-center">G</div></div><div><h4 class="text-white font-medium">Google Login erzwingen</h4><p class="text-xs text-slate-400">OAuth Authentifizierung.</p></div></div>
                                <label class="relative inline-flex items-center cursor-pointer"><input type="checkbox" id="google-auth-toggle" class="sr-only peer"><div class="w-11 h-6 bg-slate-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div></label>
                            </div>
                            <div class="bg-slate-700/30 p-4 rounded-xl border border-slate-700">
                                <div class="flex items-start space-x-3 mb-3"><i data-lucide="globe-lock" class="w-5 h-5 text-purple-400 mt-0.5"></i><div><h4 class="text-white font-medium">GeoIP Blocking</h4><p class="text-xs text-slate-400">Zugriff einschränken.</p></div></div>
                                <select id="geoip-select" class="w-full bg-slate-900 border border-slate-600 text-white px-3 py-2 rounded-lg text-sm"><option value="none">Weltweit</option><option value="lan">Nur LAN</option><option value="de">Nur DE</option><option value="eu">Nur Europa</option></select>
                            </div>
                            <div class="bg-slate-700/30 p-4 rounded-xl border border-slate-700 flex items-center justify-between">
                                <div class="flex items-start space-x-3"><i data-lucide="ban" class="w-5 h-5 text-red-400 mt-0.5"></i><div><h4 class="text-white font-medium">Fail2Ban</h4><p class="text-xs text-slate-400">Auto-Block bei Fehlern.</p></div></div>
                                <label class="relative inline-flex items-center cursor-pointer"><input type="checkbox" id="fail2ban-toggle" class="sr-only peer" checked><div class="w-11 h-6 bg-slate-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div></label>
                            </div>
                        </div>

                        <!-- Advanced Tab -->
                        <div id="tab-content-advanced" class="hidden space-y-6">
                            <div class="bg-slate-700/30 p-4 rounded-xl border border-slate-700 flex items-center justify-between">
                                <div class="flex items-start space-x-3"><i data-lucide="arrow-left-right" class="w-5 h-5 text-yellow-400 mt-0.5"></i><div><h4 class="text-white font-medium">WebSockets</h4><p class="text-xs text-slate-400">Für Echtzeit-Apps.</p></div></div>
                                <label class="relative inline-flex items-center cursor-pointer"><input type="checkbox" id="websocket-toggle" class="sr-only peer"><div class="w-11 h-6 bg-slate-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div></label>
                            </div>
                            <div class="bg-slate-700/30 p-4 rounded-xl border border-slate-700">
                                <div class="flex items-center justify-between mb-2">
                                    <div class="flex items-start space-x-3"><i data-lucide="zap" class="w-5 h-5 text-orange-400 mt-0.5"></i><div><h4 class="text-white font-medium">Wake-on-LAN</h4><p class="text-xs text-slate-400">Green Mode.</p></div></div>
                                    <label class="relative inline-flex items-center cursor-pointer"><input type="checkbox" id="wol-toggle" class="sr-only peer" onchange="toggleMacField()"><div class="w-11 h-6 bg-slate-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div></label>
                                </div>
                                <input id="input-mac" class="w-full bg-slate-800 border border-slate-600 rounded px-3 py-2 text-white text-sm hidden" placeholder="MAC Adresse (z.B. AA:BB:CC:DD:EE:FF)">
                            </div>
                        </div>
                    </div>
                    
                    <div class="p-6 border-t border-slate-700 pt-4">
                        <button onclick="saveNewHost()" class="w-full bg-blue-600 text-white py-2 rounded font-medium">Speichern</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let map;
        let hosts = [];
        let currentDomain = "";
        let selectedApp = null;
        let isHostingStatic = false;

        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            checkAuthStatus();
            // Close dropdowns
            document.addEventListener('click', (e) => {
                if(!e.target.closest('button')) {
                     document.querySelectorAll('[id^="menu-"]').forEach(el => el.classList.add('hidden'));
                }
            });
        });

        // --- Auth ---
        async function checkAuthStatus() {
            try {
                const res = await fetch('/api/auth/status');
                const status = await res.json();
                
                if (status.domain) currentDomain = status.domain;
                else currentDomain = window.location.hostname;
                
                document.getElementById('dash-domain').innerText = currentDomain;
                document.querySelectorAll('.domain-ph').forEach(e => e.innerText = currentDomain);
                document.getElementById('domain-suffix').innerText = "." + currentDomain;
                document.getElementById('view-loading').classList.add('hidden');
                
                if (!status.setup_done) showView('view-setup');
                else if (!status.logged_in) showView('view-login');
                else {
                    showView('view-dashboard');
                    initDashboard();
                }
            } catch(e) {
                console.error(e);
                document.getElementById('view-loading').innerHTML = '<p class="text-red-500">Verbindung fehlgeschlagen</p>';
            }
        }

        function showView(id) {
            ['view-setup', 'view-login', 'view-dashboard'].forEach(v => document.getElementById(v).classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
        }

        async function doSetup(e) {
            e.preventDefault();
            const btn = document.getElementById('setup-btn');
            const originalText = btn.innerText;
            btn.innerHTML = `<i data-lucide="loader-2" class="animate-spin w-5 h-5 mr-2"></i> Wird eingerichtet...`;
            lucide.createIcons();
            btn.disabled = true;

            const data = {
                domain: document.getElementById('setup-domain').value,
                email: document.getElementById('setup-email').value,
                user: document.getElementById('setup-user').value,
                password: document.getElementById('setup-pass').value
            };
            
            try {
                const res = await fetch('/api/auth/setup', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(data) });
                if(res.ok) location.reload();
                else { alert("Fehler: " + await res.text()); btn.innerHTML = originalText; btn.disabled = false; }
            } catch(err) { alert("Netzwerkfehler."); btn.innerHTML = originalText; btn.disabled = false; }
        }

        async function doLogin(e) {
            e.preventDefault();
            const data = { user: document.getElementById('login-user').value, password: document.getElementById('login-pass').value };
            const res = await fetch('/api/auth/login', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(data) });
            if(res.ok) location.reload();
            else document.getElementById('login-error').classList.remove('hidden');
        }

        // --- Settings ---
        function openSettings() {
            document.getElementById('settings-modal').classList.remove('hidden');
            loadSettings();
        }
        function closeSettings() { document.getElementById('settings-modal').classList.add('hidden'); }
        function switchSetTab(tab) {
            document.getElementById('set-tab-oauth').classList.add('hidden');
            document.getElementById('set-tab-firewall').classList.add('hidden');
            document.getElementById('set-btn-oauth').className = "pb-2 px-4 border-b-2 border-transparent text-slate-400 font-medium";
            document.getElementById('set-btn-firewall').className = "pb-2 px-4 border-b-2 border-transparent text-slate-400 font-medium";
            document.getElementById('set-tab-'+tab).classList.remove('hidden');
            document.getElementById('set-btn-'+tab).className = "pb-2 px-4 border-b-2 border-blue-500 text-blue-400 font-medium";
        }
        async function loadSettings() {
            try {
                const res = await fetch('/api/config');
                const conf = await res.json();
                document.getElementById('conf-client-id').value = conf.google_client_id || "";
                document.getElementById('conf-client-secret').value = conf.google_client_secret || "";
                document.getElementById('conf-whitelist').value = (conf.whitelist || []).join("\n");
                document.getElementById('conf-blacklist').value = (conf.blacklist || []).join("\n");
            } catch(e) {}
        }
        async function saveSettings() {
            const data = {
                google_client_id: document.getElementById('conf-client-id').value,
                google_client_secret: document.getElementById('conf-client-secret').value,
                whitelist: document.getElementById('conf-whitelist').value.split("\n").filter(l => l.trim() !== ""),
                blacklist: document.getElementById('conf-blacklist').value.split("\n").filter(l => l.trim() !== "")
            };
            await fetch('/api/config', { method: 'POST', body: JSON.stringify(data) });
            closeSettings();
            alert("Einstellungen gespeichert.");
        }

        // --- Dashboard ---
        function initDashboard() {
            initMap();
            loadHosts();
            setInterval(loadHosts, 2000);
            setInterval(loadLogs, 1500);
            setInterval(loadStats, 2000);
        }
        
        function initMap() {
            map = L.map('map', { zoomControl: false, attributionControl: false }).setView([51.1657, 10.4515], 4);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);
        }
        async function loadHosts() {
            const res = await fetch('/api/hosts');
            hosts = await res.json();
            if(!hosts) hosts = [];
            renderHosts(); renderFlow();
        }
        async function loadStats() {
            try {
                const res = await fetch('/api/stats');
                const stats = await res.json();
                document.getElementById('stat-ping').innerText = stats.ping > 0 ? stats.ping + " ms" : "Timeout";
                document.getElementById('stat-banned').innerText = stats.bannedCount;
                document.getElementById('stat-hosts').innerText = stats.activeHosts;
            } catch(e){}
        }
        async function loadLogs() {
            const res = await fetch('/api/logs');
            const logs = await res.json();
            const container = document.getElementById('live-log-list');
            if(!logs.length) return;
            const firstLog = logs[0];
            const currentFirst = container.firstElementChild?.dataset?.time;
            if(currentFirst === firstLog.time + firstLog.ip) return;

            container.innerHTML = '';
            logs.forEach(log => {
                const color = log.status === 'BLOCKED' || log.status === '404' ? 'text-red-400' : 'text-green-400';
                const div = document.createElement('div');
                div.dataset.time = log.time + log.ip;
                div.className = "flex justify-between border-b border-slate-700/50 pb-1";
                div.innerHTML = `<span class="text-slate-500">${log.time}</span> <span class="${color} font-bold">${log.status}</span> <span class="text-white">${log.ip}</span> <span class="text-slate-400 truncate w-24 text-right">${log.message}</span>`;
                container.appendChild(div);
            });
            // Marker
            if(firstLog.status !== 'LAN' && firstLog.status !== 'ALLOW' && Math.random() > 0.5) {
                // Hier in Prod echte GeoIP Coords verwenden, wir simulieren marker-popups für logs
                const lat = 48 + Math.random() * 6; const lng = 6 + Math.random() * 10;
                const color = firstLog.status === 'BLOCKED' ? '#ef4444' : '#4ade80';
                const icon = L.divIcon({className: `pulse-icon ${firstLog.status==='BLOCKED'?'marker-red':'marker-green'}`, iconSize: [12,12], iconAnchor: [6,6]});
                const m = L.marker([lat, lng], {icon: icon}).addTo(map);
                setTimeout(()=>map.removeLayer(m), 3000);
            }
        }

        function renderHosts() {
            const grid = document.getElementById('host-grid'); grid.innerHTML = '';
            const addButtonHTML = `<button onclick="openWizard()" class="border-2 border-dashed border-slate-700 rounded-xl p-6 flex flex-col items-center justify-center text-slate-500 hover:text-blue-400 hover:border-blue-500/50 hover:bg-slate-800/50 transition-all group h-full min-h-[180px] order-last"><div class="w-12 h-12 bg-slate-800 rounded-full flex items-center justify-center mb-3 group-hover:scale-110 transition-transform"><i data-lucide="plus" class="w-6 h-6"></i></div><span class="font-medium">Dienst hinzufügen</span></button>`;
            
            hosts.forEach(h => {
                const isSleeping = h.status === 'sleeping';
                const isMaintenance = h.status === 'maintenance';
                let statusColor = 'bg-green-500';
                if(h.status === 'down') statusColor = 'bg-red-500';
                if(isSleeping) statusColor = 'bg-slate-500';
                if(isMaintenance) statusColor = 'bg-orange-500';

                let badges = '';
                if(h.features?.googleAuth) badges += `<div class="bg-white text-slate-900 rounded-full w-5 h-5 flex items-center justify-center font-bold text-[10px] mr-1" title="Google Auth">G</div>`;
                if(h.features?.geo && h.features?.geo !== 'none') badges += `<div class="bg-purple-500/20 text-purple-400 rounded-full w-5 h-5 flex items-center justify-center border border-purple-500/50 mr-1" title="Geo: ${h.features.geo.toUpperCase()}"><i data-lucide="globe" class="w-3 h-3"></i></div>`;
                if(h.features?.wol) badges += `<div class="bg-green-500/20 text-green-400 rounded-full w-5 h-5 flex items-center justify-center border border-green-500/50 mr-1" title="WOL"><i data-lucide="zap" class="w-3 h-3"></i></div>`;
                if(isMaintenance) badges += `<div class="bg-orange-500/20 text-orange-400 rounded-full w-5 h-5 flex items-center justify-center border border-orange-500/50 mr-1" title="Wartung"><i data-lucide="cone" class="w-3 h-3"></i></div>`;

                const opacityClass = isSleeping ? 'opacity-50 grayscale hover:grayscale-0 hover:opacity-100' : '';
                const menuId = `menu-${h.id}`;

                const div = document.createElement('div');
                div.className = `host-card relative group ${opacityClass} transition duration-500`;
                div.innerHTML = `
                    <div class="absolute -inset-0.5 bg-gradient-to-r from-blue-500 to-purple-600 rounded-2xl opacity-0 group-hover:opacity-30 transition duration-500 blur"></div>
                    <div class="relative flex flex-col p-4 bg-slate-800 border border-slate-700 rounded-xl hover:bg-slate-750 transition-all shadow-lg h-full min-h-[180px]">
                        <div class="flex justify-between items-start mb-3">
                            <div class="p-3 bg-slate-700/50 rounded-lg relative"><i data-lucide="${h.icon||'server'}" class="w-6 h-6 text-blue-300"></i>${isSleeping ? '<div class="absolute inset-0 flex items-center justify-center bg-slate-900/60 rounded-lg"><i data-lucide="moon" class="w-4 h-4 text-white"></i></div>' : ''}</div>
                            <div class="flex items-center"><div class="flex mr-2">${badges}</div><div class="w-3 h-3 rounded-full ${statusColor} border-2 border-slate-800 shadow-[0_0_10px_currentColor]"></div></div>
                        </div>
                        <div class="flex-1 min-w-0 mb-3"><h3 class="text-white font-medium truncate text-lg">${h.name}</h3><div class="flex items-center text-xs text-slate-400 mt-1"><span class="truncate max-w-[180px]">${h.subdomain}${currentDomain ? '.'+currentDomain : ''}</span><i data-lucide="lock" class="w-3 h-3 ml-1 text-green-400"></i></div></div>
                        <div class="flex justify-between items-center border-t border-slate-700/50 pt-3 mt-auto relative">
                             <div class="text-xs font-mono text-slate-500">${h.internalIp}:${h.port}</div>
                             <button class="text-slate-400 hover:text-white transition p-1 rounded hover:bg-slate-700" onclick="toggleMenu('${menuId}')"><i data-lucide="more-horizontal" class="w-4 h-4"></i></button>
                             <div id="${menuId}" class="hidden absolute right-0 bottom-8 w-48 bg-slate-800 border border-slate-600 rounded-lg shadow-xl z-20 py-1 text-sm">
                                <button onclick="openGuestPass('${h.id}', '${h.name}', '${h.subdomain}')" class="w-full text-left px-4 py-2 hover:bg-slate-700 flex items-center text-slate-300"><i data-lucide="share-2" class="w-3 h-3 mr-2"></i> Gäste-Pass</button>
                                <button onclick="toggleMaintenance('${h.id}')" class="w-full text-left px-4 py-2 hover:bg-slate-700 flex items-center text-orange-400"><i data-lucide="cone" class="w-3 h-3 mr-2"></i> Wartung</button>
                                <button onclick="toggleWake('${h.id}')" class="w-full text-left px-4 py-2 hover:bg-slate-700 flex items-center text-blue-400"><i data-lucide="moon" class="w-3 h-3 mr-2"></i> Schlaf/Wach</button>
                                <button onclick="deleteHost('${h.id}')" class="w-full text-left px-4 py-2 hover:bg-slate-700 flex items-center text-red-400"><i data-lucide="trash" class="w-3 h-3 mr-2"></i> Löschen</button>
                             </div>
                        </div>
                    </div>`;
                grid.appendChild(div);
            });
            grid.insertAdjacentHTML('beforeend', addButtonHTML);
            lucide.createIcons();
        }

        function renderFlow() {
            const el = document.getElementById('flow-connections'); el.innerHTML = '';
            hosts.forEach(h => {
                if(h.status !== 'sleeping')
                    el.innerHTML += `<div class="flex items-center gap-2 opacity-50"><div class="h-0.5 w-8 bg-slate-600"></div><div class="text-xs text-slate-400 border border-slate-600 px-2 py-1 rounded bg-slate-800">${h.name}</div></div>`;
            });
        }
        
        // Actions
        function toggleMenu(id) {
            const menu = document.getElementById(id);
            document.querySelectorAll('[id^="menu-"]').forEach(el => { if(el.id !== id) el.classList.add('hidden'); });
            menu.classList.toggle('hidden');
        }
        async function toggleWake(id) {
            const host = hosts.find(h => h.id === id);
            host.status = host.status === 'sleeping' ? 'healthy' : 'sleeping';
            await saveHostApi(host);
            showUndo(host.status === 'sleeping' ? "Server schläft jetzt" : "Wake-on-LAN gesendet");
        }
        async function toggleMaintenance(id) {
            const host = hosts.find(h => h.id === id);
            host.status = host.status === 'maintenance' ? 'healthy' : 'maintenance';
            await saveHostApi(host);
            showUndo("Wartungsmodus " + (host.status === 'maintenance' ? 'aktiviert' : 'deaktiviert'));
        }
        async function openGuestPass(id, name, sub) {
            document.getElementById('gp-service-name').innerText = name;
            const res = await fetch(`/api/guest-token?id=${id}`);
            const data = await res.json();
            document.getElementById('gp-link').innerText = `https://${sub}.${currentDomain}/?token=${data.token}`;
            document.getElementById('guest-pass-modal').classList.remove('hidden');
            toggleMenu(`menu-${id}`);
        }
        function closeGuestPass() { document.getElementById('guest-pass-modal').classList.add('hidden'); }
        async function saveHostApi(host) {
            await fetch('/api/hosts', { method: 'POST', body: JSON.stringify(host) });
            loadHosts();
        }
        function showUndo(msg) {
            const t = document.getElementById('undo-toast');
            document.getElementById('undo-message').innerText = msg;
            t.classList.remove('hidden');
            setTimeout(() => t.classList.add('hidden'), 3000);
        }
        function closeUndo() { document.getElementById('undo-toast').classList.add('hidden'); }

        // Wizard
        async function openWizard() {
            document.getElementById('wizard-modal').classList.remove('hidden');
            document.getElementById('scan-loading').classList.remove('hidden');
            document.getElementById('scan-results').classList.add('hidden');
            document.getElementById('wizard-step-2').classList.add('hidden');
            
            try {
                const res = await fetch('/api/scan');
                const results = await res.json();
                const list = document.getElementById('scan-list');
                list.innerHTML = '';
                results.forEach(item => {
                    const btn = document.createElement('button');
                    btn.className = "flex items-center gap-3 w-full p-3 bg-slate-700/50 hover:bg-slate-700 border border-slate-600 rounded-xl text-left transition";
                    btn.innerHTML = `<i data-lucide="${item.icon}" class="text-blue-400"></i><div><div class="text-white font-bold">${item.name}</div><div class="text-xs text-slate-400">${item.ip}:${item.port}</div></div>`;
                    btn.onclick = () => selectScanResult(item);
                    list.appendChild(btn);
                });
                lucide.createIcons();
            } catch(e) {}
            document.getElementById('scan-loading').classList.add('hidden');
            document.getElementById('scan-results').classList.remove('hidden');
        }
        function closeWizard() { document.getElementById('wizard-modal').classList.add('hidden'); }
        function switchTab(tab) {
            ['connection', 'security', 'advanced'].forEach(t => {
                document.getElementById(`tab-content-${t}`).classList.add('hidden');
                document.getElementById(`tab-btn-${t}`).classList.remove('border-blue-500', 'text-blue-400');
                document.getElementById(`tab-btn-${t}`).classList.add('border-transparent', 'text-slate-400');
            });
            document.getElementById(`tab-content-${tab}`).classList.remove('hidden');
            const activeBtn = document.getElementById(`tab-btn-${tab}`);
            activeBtn.classList.remove('border-transparent', 'text-slate-400');
            activeBtn.classList.add('border-blue-500', 'text-blue-400');
        }
        function manualSetup() {
            isHostingStatic = false;
            showStep2();
            document.getElementById('input-ip').value = "192.168.178.x";
            document.getElementById('fetch-icon-btn').classList.remove('hidden');
            document.getElementById('internal-config-row').classList.remove('hidden');
            document.getElementById('static-hosting-banner').classList.add('hidden');
        }
        function startStaticHosting() {
            isHostingStatic = true;
            showStep2();
            document.getElementById('fetch-icon-btn').classList.add('hidden');
            document.getElementById('internal-config-row').classList.add('hidden');
            document.getElementById('static-hosting-banner').classList.remove('hidden');
            document.getElementById('input-name').value = "Statische Webseite";
            document.getElementById('input-sub').value = "webseite";
        }
        function selectScanResult(item) {
            isHostingStatic = false;
            showStep2();
            document.getElementById('fetch-icon-btn').classList.add('hidden');
            document.getElementById('internal-config-row').classList.remove('hidden');
            document.getElementById('static-hosting-banner').classList.add('hidden');
            document.getElementById('input-name').value = item.name;
            document.getElementById('input-ip').value = item.ip;
            document.getElementById('input-port').value = item.port;
            document.getElementById('input-sub').value = item.name.toLowerCase().replace(/[^a-z0-9]/g, '-');
        }
        function showStep2() {
            document.getElementById('wizard-step-1').classList.add('hidden');
            document.getElementById('wizard-step-2').classList.remove('hidden');
            switchTab('connection');
            document.getElementById('google-auth-toggle').checked = false;
            document.getElementById('fail2ban-toggle').checked = true;
            document.getElementById('websocket-toggle').checked = false;
            document.getElementById('wol-toggle').checked = false;
        }
        function fetchFavicon() {
            const ip = document.getElementById('input-ip').value;
            const port = document.getElementById('input-port').value;
            const btn = document.getElementById('fetch-icon-btn');
            btn.innerHTML = `<i data-lucide="loader-2" class="w-3 h-3 animate-spin"></i> Suche Icon...`;
            fetch(`/api/fetch-icon?url=${ip}:${port}`)
                .then(r=>r.json())
                .then(d => {
                    btn.innerHTML = `<i data-lucide="check" class="w-3 h-3 text-green-400"></i> Icon gefunden!`;
                    // Hier würde man das Icon speichern, vereinfacht belassen wir es bei 'server' in der save func, aber die Logic ist da
                });
        }
        function toggleMacField() {
            const active = document.getElementById('wol-toggle').checked;
            const field = document.getElementById('input-mac');
            if(active) field.classList.remove('hidden'); else field.classList.add('hidden');
        }
        async function uploadFile() {
            const file = document.getElementById('file-upload').files[0];
            const sub = document.getElementById('input-sub').value;
            if(!file || !sub) return;
            const formData = new FormData(); formData.append("file", file); formData.append("subdomain", sub);
            const res = await fetch('/api/upload', { method: 'POST', body: formData });
            if(res.ok) document.getElementById('upload-status').classList.remove('hidden');
        }
        async function saveNewHost() {
            const sub = document.getElementById('input-sub').value;
            const ip = document.getElementById('input-ip').value;
            const port = document.getElementById('input-port').value;
            const host = {
                id: Math.random().toString(36).substr(2, 9),
                name: document.getElementById('input-name').value,
                internalIp: isHostingStatic ? 'Local' : (ip || '127.0.0.1'),
                port: isHostingStatic ? 80 : (parseInt(port) || 80),
                subdomain: sub,
                icon: isHostingStatic ? 'layout' : 'server',
                status: 'healthy',
                mac: document.getElementById('input-mac').value,
                features: {
                    googleAuth: document.getElementById('google-auth-toggle').checked,
                    geo: document.getElementById('geoip-select').value,
                    websockets: document.getElementById('websocket-toggle').checked,
                    wol: document.getElementById('wol-toggle').checked,
                    fail2ban: document.getElementById('fail2ban-toggle').checked
                }
            };
            await saveHostApi(host);
            closeWizard();
            showUndo("Dienst erfolgreich erstellt");
        }
        async function deleteHost(id) {
            if(confirm('Wirklich löschen?')) { await fetch('/api/hosts?id=' + id, { method: 'DELETE' }); loadHosts(); }
        }
    </script>
</body>
</html>